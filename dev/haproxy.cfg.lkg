# _md5hash=6efee873c8f015dd596b33d26e6d3a37
# _version=9
# Dataplaneapi managed File
# changing file directly can cause a conflict if dataplaneapi is running

global
  maxconn 4096
  stats socket /tmp/haproxy.sock mode 660 level admin

defaults unnamed_defaults_1
  mode http
  option httplog
  timeout connect 15s
  timeout client 60s
  timeout server 60s

# Data Plane API authentication
userlist dataplaneapi
  user admin insecure-password adminpwd

frontend http from unnamed_defaults_1
  bind *:80
  redirect scheme https code 301

frontend https from unnamed_defaults_1
  bind *:443
  default_backend test_backend

frontend stats from unnamed_defaults_1
  bind *:8099
  stats enable
  stats uri /stats
  stats refresh 10s

backend dynamic_backend
  balance roundrobin
  server server1 127.0.0.1:9999 check

backend test_api
  balance roundrobin
  server test_api_1 192.168.1.100:8080 check

# Initial test backend
backend test_backend from unnamed_defaults_1
  balance roundrobin
  server nginx test-backend:80 check

# Data Plane API program
program api
  command /usr/bin/dataplaneapi --host 0.0.0.0 --port 5555 --haproxy-bin /usr/local/sbin/haproxy --config-file /usr/local/etc/haproxy/haproxy.cfg --reload-cmd "kill -SIGUSR2 1" --restart-cmd "kill -SIGUSR2 1" --reload-delay 5 --userlist dataplaneapi
  no option start-on-reload
