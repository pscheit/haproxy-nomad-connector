# _md5hash=66572bfca7ce5629b4cd229671f8ed87
# _version=275
# Dataplaneapi managed File
# changing file directly can cause a conflict if dataplaneapi is running

global
  maxconn 4096
  stats socket /tmp/haproxy.sock mode 660 level admin

defaults unnamed_defaults_1
  mode http
  option httplog
  timeout connect 15s
  timeout client 60s
  timeout server 60s

# Data Plane API authentication
userlist dataplaneapi
  user admin insecure-password adminpwd

frontend http from unnamed_defaults_1
  bind *:80
  default_backend error_404

frontend https from unnamed_defaults_1
  bind *:443
  default_backend error_404

frontend stats from unnamed_defaults_1
  bind *:8099
  stats enable
  stats uri /stats
  stats refresh 10s

# Error backend that returns 404 for unmatched domains
backend error_404 from unnamed_defaults_1
  http-request return status 404 content-type "text/plain" string "404 - Domain not found"

# Initial test backend for nginx container
backend test_backend from unnamed_defaults_1
  balance roundrobin
  server nginx test-backend:80 check

# Data Plane API program
program api
  command /usr/bin/dataplaneapi --host 0.0.0.0 --port 5555 --haproxy-bin /usr/local/sbin/haproxy --config-file /usr/local/etc/haproxy/haproxy.cfg --reload-cmd "kill -SIGUSR2 1" --restart-cmd "kill -SIGUSR2 1" --reload-delay 5 --userlist dataplaneapi
  no option start-on-reload
